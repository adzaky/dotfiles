#!/bin/bash
#
# Mount sparsed android system and vendor
# sparsed file will be transformed to the .img
# and then will be mounted to the target dir
#
# usage :
#   $ cd path/to/rom/dir
#   $ rom-mount path/to/target/dir
#

TARGET=$1

log() {
    TAG=$(basename $0)
    printf "$TAG: %s\n" "$1"
}

dump() {
    file=$1
    targetmount=$2
    if [[ -f $file.new.dat.br ]]; then
        log "decompressing $file"
        brotli --decompress $file.new.dat.br
        sdat2img $file.transfer.list $file.new.dat $file.img
        rm -rf $file.{new.dat.br,new.dat,transfer.list,patch.dat}
        log "decompressing $file done"
    fi
    if [[ -f $file.img ]]; then
        mkdir -p $targetmount
        log "mounting $file into $targetmount"
        sudo mount -o ro $file.img $targetmount
        log "mounting $file done"
    fi
}

main() {
    if ! ls $(pwd) | grep -qE '(vendor|system)\.(img|new\.dat\.br)'; then
        log "no system or vendor images to extract, exiting"
        exit 1
    fi

    if [[ $TARGET == "" ]]; then
        log "target is empty, please run $(basename $0) <target-dir>"
    elif [[ ! -d $TARGET ]]; then
        log "target directory not found, creating ones"
        mkdir $TARGET
    fi

    dump system $TARGET
    dump vendor $TARGET/vendor
}

main $0
