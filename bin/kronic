#!/bin/bash
DEFAULT_CFG=derp_raphael-userdebug
CCACHE_SIZE=50G
GDRIVE_UPLOAD_PARENT=

if [[ ! -f "build/envsetup.sh" ]]; then
    echo "you're in the wrong dir. exiting"
    exit 1
fi

# Load ~/.kronicrc for easier configuration override
[[ -f "$HOME/.kronicrc" ]] && source $HOME/.kronicrc

[[ -z $1 ]] && CFG=$DEFAULT_CFG || CFG=$1
cfg=($(sed -e 's/_/ /;s/-/ /;' <<< "$CFG"))
cfg_rom=${cfg[0]}
cfg_device=${cfg[1]}
cfg_variant=${cfg[2]}

outdir=$(pwd)/out
outdevicedir=$outdir/target/product/$cfg_device

_interrupted() {
    echo "Script interrupted. exiting immediately."
    exit 1
}

telereport() {
    if [[ -f ${2} ]]; then
        telegram-send --file "${2}" --caption "${1}"
    else
        telegram-send --format markdown "${1}"
    fi
}

set_ccache() {
    export USE_CCACHE=1 CCACHE_DIR="~/.ccache" CCACHE_EXEC=$(which ccache)
    CURR=$($CCACHE_EXEC -p | grep max_size | sed -e 's/.*e = \(.*\)\..*G/\1/')
    [[ "${CURR}G" != "$1" ]] && $CCACHE_EXEC -M $1
}

cleanup_build_info() {
    if [[ -d "$outdir/" ]]; then
        find $outdir/ -maxdepth 1 -type f -iname 'build_*.txt' -print -delete
        if [[ -d "$outdir/target/product/$cfg_device" ]]; then
            find $outdir/target/product/$cfg_device -maxdepth 1 -type f -iname 'build_*.txt' -print -delete
            find $outdir/target/product/$cfg_device -maxdepth 6 -type f -iname 'build.prop' -print -delete
            find $outdir/target/product/$cfg_device -maxdepth 6 -type f -iname 'Changelog.txt' -print -delete
        fi
    fi
    if [[ -f "$outdevicedir/obj/KERNEL_OBJ/.version" ]]; then
        echo 0 > $outdevicedir/obj/KERNEL_OBJ/.version
    fi
}

main() {
    failed=0

    export TEMPORARY_DISABLE_PATH_RESTRICTIONS=true

    echo "Building $cfg_rom for: $cfg_device"
    if [[ -n $GDRIVE_UPLOAD_PARENT ]]; then
        echo "GDrive-upload Parent Location: $GDRIVE_UPLOAD_PARENT"
    fi

    source build/envsetup.sh

    lunch $CFG || exit 1
    telereport "Build process of *$cfg_rom* for *$cfg_device* started at $(date)"
    mka kronic || failed=1

    if [[ $failed == 1 ]]; then
        errlog=/tmp/error-$cfg_rom-$cfg_device_$(date +%F__%I-%M%P).buildlog.txt

        telereport "Shishou, your *$cfg_rom* build for *$cfg_device* is failed at $(date)."
        cp $outdir/error.log $errlog
        telereport "Here is the error log :)" $errlog
        exit 1
    fi

    telereport "Shishou, your *$cfg_rom* build for *$cfg_device* is finished at $(date)."

    zipfile=$(find $outdevicedir -maxdepth 1 -name 'DerpFest-*.zip' -printf "%f\n" | sort -n | tail -n1)
    zipname=${zipfile//.zip/}
    telereport "I'm gonna push *$zipname* to your Google Drive now."

    if [[ -n $GDRIVE_UPLOAD_PARENT ]]; then
        gdrive upload --parent $GDRIVE_UPLOAD_PARENT $outdevicedir/$zipfile || failed=1
    else
        gdrive upload $outdevicedir/$zipfile || failed=1
    fi

    if [[ $failed == 1 ]]; then
        telereport "Sumimasen shishou! I can't access your Google Drive :("
        exit 1
    fi

    if [[ -n $GDRIVE_UPLOAD_PARENT ]]; then
        gdrive_url="https://drive.google.com/drive/folders/$GDRIVE_UPLOAD_PARENT"
    else
        gdrive_url="https://drive.google.com/drive"
    fi

    cp $outdevicedir/Changelog.txt $outdevicedir/changelog.txt

    telereport "$zipname is uploaded at your [Google Drive]($gdrive_url)"
    telereport "Hash : " $outdevicedir/$zipfile.md5sum
    telereport "Metadata : " $outdevicedir/raphael.json
    telereport "Changelog : " $outdevicedir/changelog.txt
}

trap '_interrupted' SIGINT

set_ccache $CCACHE_SIZE
cleanup_build_info
main $@
